<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/assets/bootstrap-4.0.0/css/bootstrap.min.css">
    

</head>
<body>

    <div class="container">
      
        <h1>Customer information</h1>
           
        <form id="frmCreate">
            <div class="row">
                <div class="col-lg-6 ">
                    <label class="form-lable">Full name</label>
                    <input type="text" class="form-control" id="fullName" name="fullName">
                </div>
                <div class="col-lg-6" >
                    <label class="form-lable">Email</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>
            </div>
        
            <div class="row mt-3">
                <div class="col-lg-6" >
                    <label class="form-lable">Phone</label>
                    <input type="tel" class="form-control" id="phone" name="phone">
                </div>
                <div class="col-lg-6">
                    <label class="form-lable">Address</label>
                    <input type="text" class="form-control" id="address" name="address">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-lg-3" >
                    <button type="button" class="btn btn-outline-primary" id="btnCreate"> 
                        Create
                    </button>
                </div>
            </div>
        </form>
        
        <div>
            <table class="table table-hover mt-3" id="tbCustomer">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>FullName</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Balance</th>
                        <th class="text-center" colspan="2">Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>  
    </div>

    <!-- Modal Update -->
    <div class="modal fade " id="mdUpdate" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <form id="frmUpdate">
                    <div class="row">
                        <div class="col-lg-6">
                            <input type="hidden" id="customerIdUp">
                            <label for="fullName">Full Name</label>
                            <input type="text" id="fullNameUp" class="form-control">
                        </div>
                        <div class="col-lg-6">
                            <label for="email">Email</label>
                            <input type="email" id="emailUp" class="form-control">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-lg-6">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phoneUp" class="form-control">
                        </div>
                        <div class="col-lg-6">
                            <label for="address">Address</label>
                            <input type="text" id="addressUp" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
              <button type="button" id="btnUpdate" class="btn btn-outline-primary">Update</button>
            </div>
          </div>
        </div>
      </div>

    <script src="/assets/js/jquery-3.6.0.min.js"></script>
    <script src="/assets/bootstrap-4.0.0/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/app.js"></script>

    <script>
        
        let customers = [];
        let customer = new Customer();
        
        customer.id = 1;
        customer.fullName ='NVA';
        customer.email ='nva@gmail.com';
        customer.phone = '11111';
        customer.address ='Hue';

        customers.push(customer);
        

        //Dùng vòng for để duyệt tất cả customers
        function loadCustomers(){
            $.ajax({
                "type": "GET",
                "url": "http://localhost:3000/customers?deleted=0"
            })
            .done((data) => {
                $.each(data, (i, item) => {
                let str =`   
                    <tr id="tr_${item.id}">
                        <td> ${item.id} </td>
                        <td> ${item.fullName} </td>
                        <td> ${item.email} </td>
                        <td> ${item.phone} </td>
                        <td> ${item.address} </td>
                        <td> ${item.balance} </td>
                        <td>
                            <button type="button" data-id="${item.id}" class="btn btn-outline-secondary edit"> Edit </button>
                        </td>
                        <td>
                                <button type="button" data-id="${item.id}" class="btn btn-outline-danger deactive">Deactive</button>
                            </td>
                    </tr>
                    `;

                $('#tbCustomer tbody').prepend(str);

             });

           
            OnEditModal()

            })
        }


        loadCustomers();


        let id = 1;
        
        //Sự kiện thêm mới ở nút Create
        $('#btnCreate').on('click' , function () {

            let fullName = $('#fullName').val();
            let email = $('#email').val();
            let phone = $('#phone').val();
            let address = $('#address').val();

            delete customer.id;
            customer.fullName = fullName;
            customer.email = email;
            customer.phone = phone;
            customer.address = address;

            $.ajax({
                "type": "POST",
                "url": "http://localhost:3000/customers",
                "data": customer
            })
            .done((item) =>{
                let str =`   
                  <tr id="tr_${item.id}">
                    <td> ${item.id} </td>
                    <td> ${item.fullName} </td>
                    <td> ${item.email} </td>
                    <td> ${item.phone} </td>
                    <td> ${item.address} </td>
                    <td> ${item.balance} </td>
                    <td>
                        <button type="button"  data-id="${item.id}" class="btn btn-outline-secondary edit">Edit</button>
                    </td>
                </tr>
                `;

                $('#tbCustomer tbody').prepend(str);

                OffEditModal()
                OnEditModal()
               
            })
        });


        //Thêm giữ liệu vào nút cập nhật, lấy theo id để cập nhật lại
        $('#btnUpdate').on('click',  () => {

            customer.id = $("#customerIdUp").val();
            customer.fullName = $("#fullNameUp").val();
            customer.email = $("#emailUp").val();
            customer.phone = $("#phoneUp").val();
            customer.address = $("#addressUp").val();

            $.ajax({
                "type": "PUT",
                "url": "http://localhost:3000/customers/" + customer.id,
                "data": customer
            })

            .done((item) =>{
            
                //Cập nhật lại theo id, và thêm lại các phần tử mới truyền vào lại nó để cập nhật
                let currentRow = $('#tr_' + item.id);

                let updateRow=`
                    <tr id="tr_${item.id}">
                        <td> ${item.id} </td>
                        <td> ${item.fullName} </td>
                        <td> ${item.email} </td>
                        <td> ${item.phone} </td>
                        <td> ${item.address} </td>
                        <td> ${item.balance} </td>
                        <td>
                            <button type="button"  data-id="${item.id}" class="btn btn-outline-secondary edit">Edit</button>
                        </td>
                    </tr>
                `;
                currentRow.replaceWith(updateRow);

                  //Khi cập nhật thành công thì ta tiến hành đóng modal lại
                  $('#mdUpdate').modal('hide');


                  //Ta tiến hành gọi hàm để tiếp tục thực hiện   
                 
                  OnEditModal();
                
            })

            // .fail((error)=>{

            // })

        })


        //Edit theo id, và truyền các giá trị đó vào các thẻ input, tìm id theo server 3000 để lấy đc thông tin ra
        function OnEditModal(){
            $('.edit').on('click', function(){
                let id = $(this).data('id');
        
                $.ajax({
                    "type" : "GET",
                    "url": "http://localhost:3000/customers/" + id
                })
                .done((data) =>{
                    
                    $("#customerIdUp").val(data.id);
                    $("#fullNameUp").val(data.fullName);
                    $("#emailUp").val(data.email);
                    $("#phoneUp").val(data.phone);
                    $("#addressUp").val(data.address);
                    
                    $('#mdUpdate').modal('show')
                    
                })

                .fail((error) =>{
                    alert("Fail")
                })

            })
        }


        function OffEditModal(){
            $('.edit').off() 
        }
       

        



    </script>


</body>


</html>






 